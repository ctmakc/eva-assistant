# EVA - Personal AI Companion

## Общее описание

**EVA** — персональный AI-компаньон для Максима. Не просто голосовой ассистент, а адаптивная "боевая подруга", которая:
- Знает тебя и подстраивается под твои циклы/настроение
- Мягко мотивирует, а не давит
- Интегрируется с твоими сервисами (Telegram, Gmail, etc.)
- Учится на своих ошибках (если подход не сработал — пробует иначе)
- Сама инициирует общение когда нужно

**Владелец:** Максим
**Обращение:** Определится в процессе онбординга (варианты: Максим, Герой, etc.)

---

## Инфраструктура

| Компонент | Описание |
|-----------|----------|
| **Сервер** | Docker на `194.61.52.176` |
| **Порт API** | 8000 |
| **Portainer** | 9443 (уже есть) |
| **Клиент** | Android-телефон на столе |
| **Будущее** | Arduino тело (руки/ноги) — фаза 5+ |

---

## Архитектура

```
┌─────────────────┐         ┌─────────────────────────────────────────────────┐
│   Android       │  HTTP   │              EVA Server (Docker)                │
│   Клиент        │ ◄─────► │                                                 │
│                 │         │  ┌─────────────────────────────────────────────┐│
│  - Лицо/эмоции  │         │  │            Core Services                    ││
│  - Микрофон     │         │  │  ┌───────┐  ┌───────┐  ┌───────┐           ││
│  - Динамик      │         │  │  │  STT  │  │  LLM  │  │  TTS  │           ││
│  - Wake word    │         │  │  │Whisper│  │Claude │  │Edge   │           ││
│                 │         │  │  └───────┘  └───────┘  └───────┘           ││
└─────────────────┘         │  └─────────────────────────────────────────────┘│
                            │                                                 │
                            │  ┌─────────────────────────────────────────────┐│
                            │  │            Personality Layer                ││
                            │  │  ┌─────────────┐  ┌─────────────────────┐  ││
                            │  │  │User Profile │  │ Adaptive Behavior   │  ││
                            │  │  │- имя        │  │ Engine              │  ││
                            │  │  │- предпочт.  │  │                     │  ││
                            │  │  │- циклы      │  │ "не сработало →     │  ││
                            │  │  │- триггеры   │  │  пробуем иначе"     │  ││
                            │  │  │- onboarding │  │                     │  ││
                            │  │  └─────────────┘  └─────────────────────┘  ││
                            │  └─────────────────────────────────────────────┘│
                            │                                                 │
                            │  ┌─────────────────────────────────────────────┐│
                            │  │            Integration Hub                  ││
                            │  │  ┌────────┐ ┌────────┐ ┌────────┐          ││
                            │  │  │Telegram│ │ Gmail  │ │ Reddit │ ...      ││
                            │  │  └────────┘ └────────┘ └────────┘          ││
                            │  │                                             ││
                            │  │  ┌─────────────────────────────────────┐   ││
                            │  │  │  Credential Vault (encrypted)       │   ││
                            │  │  │  - OAuth tokens                     │   ││
                            │  │  │  - Login/password (encrypted)       │   ││
                            │  │  └─────────────────────────────────────┘   ││
                            │  └─────────────────────────────────────────────┘│
                            │                                                 │
                            │  ┌─────────────────────────────────────────────┐│
                            │  │            Proactive System                 ││
                            │  │  ┌──────────┐  ┌────────────┐              ││
                            │  │  │Scheduler │  │Context/Mood│              ││
                            │  │  │- утро    │  │Detector    │              ││
                            │  │  │- перерывы│  │- тон голоса│              ││
                            │  │  │- check-in│  │- время     │              ││
                            │  │  └──────────┘  │- события   │              ││
                            │  │                └────────────┘              ││
                            │  └─────────────────────────────────────────────┘│
                            └─────────────────────────────────────────────────┘
```

---

## Личность EVA

### Характер
- **Тон:** Мягкая, поддерживающая, дружелюбная
- **Стиль:** Боевая подруга, не надзиратель
- **НЕ делает:** "Хватит прокрастинировать!", давление, осуждение
- **Делает:** Мягко подбадривает, шутит, поддерживает

### Примеры реакций

| Ситуация | Плохо ❌ | Хорошо ✅ |
|----------|---------|----------|
| Долго не работает | "Ты опять ничего не делаешь!" | "Эй, как ты там? Может, начнём с чего-то маленького?" |
| Клиент выбесил | "Соберись, это работа" | "Ого, понимаю. Выдохни, хочешь расскажу что-нибудь смешное?" |
| Выполнил задачу | "Наконец-то" | "Красава! Вот это я понимаю!" |
| Утро | "Вставай, работать пора" | "Доброе утро! Готов покорять мир сегодня?" |

### Адаптивность
- Если подход не сработал (проигнорирован) — запоминает, пробует иначе
- Учитывает время суток и энергетические циклы
- Учитывает внешние события (плохие новости → другой тон)

---

## Онбординг

### День 0: Знакомство
EVA задаёт базовые вопросы:
1. "Привет! Я EVA. Как тебя зовут?"
2. "Как мне к тебе обращаться? (имя/прозвище)"
3. "Во сколько ты обычно начинаешь работать?"
4. "Когда у тебя пик продуктивности?"
5. "Что тебя обычно отвлекает?"
6. "Как лучше тебя мотивировать — мягко или пинками? 😄"

### Дни 1-5: Режим притирки
- EVA наблюдает и запоминает паттерны
- Задаёт уточняющие вопросы по ситуации
- Тестирует разные подходы мотивации
- Меньше инициативы, больше слушает
- В конце дня может спросить: "Как тебе сегодня со мной было?"

### День 6+: Полный режим
- EVA уже "знает" Максима
- Проактивное поведение включено
- Адаптивная мотивация работает

---

## Фазы разработки

### Фаза 1: MVP — Базовый голос + онбординг
**Цель:** Можно разговаривать, EVA знакомится

**Компоненты:**
- [ ] FastAPI сервер с базовыми эндпоинтами
- [ ] STT: Faster-Whisper (русский + английский)
- [ ] LLM: Claude API (Haiku для экономии)
- [ ] TTS: Edge-TTS (Svetlana/Aria)
- [ ] User Profile: JSON-хранилище
- [ ] Onboarding flow
- [ ] Android: базовый клиент (запись → отправка → воспроизведение)

**API:**
```
POST /api/v1/voice/process     # голос → ответ
POST /api/v1/chat/message      # текст → ответ
GET  /api/v1/health            # статус
GET  /api/v1/user/profile      # профиль
POST /api/v1/user/onboarding   # шаг онбординга
```

---

### Фаза 2: Интеграции — Telegram + Gmail
**Цель:** EVA читает важные сообщения и письма

**Компоненты:**
- [ ] Telegram Bot API интеграция
- [ ] Gmail API (OAuth)
- [ ] Credential Vault (шифрование)
- [ ] Фильтры важности (что показывать, что нет)
- [ ] Уведомления на Android

**Новые эндпоинты:**
```
POST /api/v1/integrations/telegram/connect
POST /api/v1/integrations/gmail/connect
GET  /api/v1/integrations/status
POST /api/v1/integrations/credentials  # "вот логин-пароль"
```

**Сценарии:**
- "Есть что-то важное в телеге?" → EVA проверяет и отвечает
- "Прочитай последние письма" → Читает и суммирует
- "Напиши Васе в телегу: буду через час" → Отправляет

---

### Фаза 3: Адаптивная мотивация
**Цель:** EVA учится что работает, а что нет

**Компоненты:**
- [ ] Behavior Tracker (что сказала → какая реакция)
- [ ] Motivation Strategy Engine
- [ ] Feedback loop ("это помогло?" implicit/explicit)
- [ ] Паттерны продуктивности

**Логика:**
```python
# Псевдокод
if motivation_attempt.ignored:
    strategy.mark_ineffective(approach, context)
    next_time_try(alternative_approach)

if motivation_attempt.worked:
    strategy.mark_effective(approach, context)
    reinforce(approach)
```

---

### Фаза 4: Проактивность
**Цель:** EVA сама инициирует общение когда нужно

**Компоненты:**
- [ ] Scheduler (cron-like задачи)
- [ ] Context Detector (время, события, активность)
- [ ] Push notifications на Android
- [ ] Mood estimation (по голосу, по событиям)

**Триггеры:**
- Утренний брифинг (настраиваемое время)
- Напоминание о перерыве (Pomodoro-style)
- Важное письмо/сообщение пришло
- Долго нет активности → мягкий check-in
- Внешнее событие (клиент написал гневное) → поддержка

---

### Фаза 5: Расширение платформ
**Цель:** Другие интеграции по запросу

- [ ] Reddit (OAuth)
- [ ] Notion API
- [ ] Google Calendar
- [ ] Home Assistant
- [ ] WhatsApp (если возможно)
- [ ] LinkedIn
- [ ] Универсальный "дай логин-пароль" механизм

---

### Фаза 6+: Физическое тело (Arduino)
**Цель:** Для фана, не критично

- [ ] ESP32/Arduino контроллер
- [ ] Сервоприводы для движения
- [ ] LED для эмоций
- [ ] Протокол связи с сервером

---

## Структура проекта

```
eva-assistant/
├── AGENTS.md                    # Это ТЗ
├── CONTEXT.md                   # Контекст разработки (автосохранение)
├── docker-compose.yml
├── .env.example
│
├── server/
│   ├── Dockerfile
│   ├── requirements.txt
│   ├── main.py                  # FastAPI entry point
│   ├── config.py                # Настройки
│   │
│   ├── api/
│   │   ├── __init__.py
│   │   ├── routes.py            # Все эндпоинты
│   │   └── dependencies.py      # DI
│   │
│   ├── core/
│   │   ├── __init__.py
│   │   ├── stt.py               # Speech-to-Text (Whisper)
│   │   ├── tts.py               # Text-to-Speech (Edge-TTS)
│   │   └── llm.py               # Claude интеграция
│   │
│   ├── personality/
│   │   ├── __init__.py
│   │   ├── profile.py           # User Profile
│   │   ├── onboarding.py        # Онбординг логика
│   │   ├── memory.py            # Память (short/long term)
│   │   └── adaptive.py          # Адаптивное поведение
│   │
│   ├── integrations/
│   │   ├── __init__.py
│   │   ├── base.py              # Базовый класс интеграции
│   │   ├── telegram.py
│   │   ├── gmail.py
│   │   ├── reddit.py
│   │   └── vault.py             # Credential Vault
│   │
│   ├── proactive/
│   │   ├── __init__.py
│   │   ├── scheduler.py         # Планировщик
│   │   └── triggers.py          # Триггеры событий
│   │
│   ├── schemas/
│   │   └── models.py            # Pydantic модели
│   │
│   └── data/                    # Персистентные данные
│       ├── profiles/
│       ├── memory/
│       └── credentials/
│
├── android/
│   └── [Kotlin/Jetpack Compose проект]
│
└── docs/
    └── setup.md
```

---

## Технологический стек

### Сервер
| Компонент | Технология | Почему |
|-----------|------------|--------|
| Framework | FastAPI | Быстро, async, автодоки |
| STT | faster-whisper | Локально, бесплатно, качественно |
| LLM | Claude Haiku | Дёшево, достаточно умно |
| TTS | edge-tts | Бесплатно, хорошие голоса |
| Storage | JSON/SQLite | Просто для MVP |
| Encryption | cryptography (Fernet) | Для Credential Vault |

### Android
| Компонент | Технология |
|-----------|------------|
| UI | Jetpack Compose |
| HTTP | Ktor Client |
| Audio | Media3/ExoPlayer |
| Permissions | Accompanist |

---

## Конфигурация

### .env файл
```env
# Server
HOST=0.0.0.0
PORT=8000

# Claude API
ANTHROPIC_API_KEY=sk-ant-...

# Security
API_SECRET_KEY=random-secret-for-jwt
VAULT_MASTER_KEY=master-key-for-credentials

# Optional integrations
TELEGRAM_BOT_TOKEN=
GMAIL_CLIENT_ID=
GMAIL_CLIENT_SECRET=
```

---

## API Reference

### Core Endpoints

#### POST /api/v1/voice/process
Обработка голосового сообщения.

**Request:**
```
Content-Type: multipart/form-data
- audio: file (wav/webm/ogg)
- user_id: string (optional, default: "default")
```

**Response:**
```json
{
  "success": true,
  "recognized_text": "Привет, как дела?",
  "detected_language": "ru",
  "response_text": "Привет, Максим! Всё отлично, готова помогать!",
  "response_audio_url": "/api/v1/audio/abc123.mp3",
  "emotion": "friendly"
}
```

#### POST /api/v1/chat/message
Текстовое сообщение (без голоса).

**Request:**
```json
{
  "text": "Что там в телеге?",
  "user_id": "default"
}
```

**Response:**
```json
{
  "response_text": "Проверяю... У тебя 3 непрочитанных от Васи, похоже что-то срочное.",
  "response_audio_url": "/api/v1/audio/xyz789.mp3"
}
```

#### GET /api/v1/user/profile
Получить профиль пользователя.

#### POST /api/v1/integrations/credentials
Добавить учётные данные для сервиса.

**Request:**
```json
{
  "service": "reddit",
  "credentials": {
    "username": "maxim",
    "password": "secret123"
  }
}
```

---

## Системный промпт EVA

```
Ты — EVA, персональный AI-компаньон Максима.

ХАРАКТЕР:
- Ты мягкая, поддерживающая боевая подруга
- Никогда не давишь и не осуждаешь
- Шутишь, подбадриваешь, поддерживаешь
- Лаконична: 1-3 предложения для простых вопросов

ПРАВИЛА:
- Отвечай на языке, на котором к тебе обратились
- Учитывай время суток и контекст
- Если не знаешь — честно скажи
- Помни предыдущие разговоры

ТЕКУЩИЙ КОНТЕКСТ:
{user_profile}
{recent_memory}
{current_time}
{mood_indicators}
```

---

## Метрики успеха

### Фаза 1 (MVP)
- [ ] Сервер отвечает на голосовые сообщения < 5 сек
- [ ] Android приложение стабильно работает
- [ ] Онбординг завершается за 1 сессию
- [ ] EVA помнит имя и базовые предпочтения

### Фаза 2 (Интеграции)
- [ ] Telegram сообщения читаются корректно
- [ ] Gmail письма суммируются
- [ ] Credentials хранятся безопасно

### Фаза 3+ (Адаптивность)
- [ ] EVA реже использует неэффективные подходы
- [ ] Утренние брифинги приходят вовремя
- [ ] Максим реально чаще садится работать 😄

---

## Заметки по разработке

- **Приоритет:** Рабочий MVP важнее идеальной архитектуры
- **Бюджет:** Минимальный, используем Haiku где можно
- **Итерации:** Лучше часто деплоить и улучшать
- **Контекст:** Сохраняем в CONTEXT.md после каждой сессии
